# mmi configuration - safe commands and wrappers for Claude Code bash approval
#
# Structure:
#   [deny.*]     - patterns that are ALWAYS rejected (checked first)
#   [wrappers.*] - prefixes stripped before checking the core command
#   [commands.*] - safe commands that are allowed to execute
#
# Section types:
#   [[*.simple]]     - name = "label", commands = [...] - any arguments allowed
#   [[*.command]]    - command = "cmd", flags = [...] - wrapper with flags
#   [[*.subcommand]] - command = "cmd", subcommands = [...], flags = [...]
#   [[*.regex]]      - pattern = "^regex$", name = "desc" - raw regex escape hatch

# ============================================================
# DENY LIST - patterns that are always rejected (checked first)
# These override any approval patterns below
# ============================================================

# Dangerous commands that should never be auto-approved
[[deny.simple]]
name = "privilege escalation"
commands = ["sudo", "su", "doas"]

# Dangerous patterns with risky argument combinations
[[deny.regex]]
pattern = "rm\s+(-[rRfF]+\s+)*/"
name = "rm root"

[[deny.regex]]
pattern = "chmod\s+(777|a\+rwx)"
name = "chmod world-writable"

[[deny.regex]]
pattern = "dd\s+.*of=/dev/"
name = "dd to device"

[[deny.regex]]
pattern = ">\s*/dev/sd[a-z]"
name = "write to disk"

[[deny.regex]]
pattern = "mkfs\."
name = "format filesystem"

# ============================================================
# WRAPPERS - prefixes stripped before checking the core command
# ============================================================

[[wrappers.simple]]
name = "env"
commands = ["env", "do"]

[[wrappers.command]]
command = "timeout"
flags = ["<arg>"]

[[wrappers.command]]
command = "nice"
flags = ["-n <arg>", ""]

[[wrappers.regex]]
pattern = "^([A-Z_][A-Z0-9_]*=[^\s]*\s+)+"
name = "env vars"

# ============================================================
# COMMANDS - safe commands that are allowed to execute
# ============================================================


[[commands.simple]]
name = "unix-and-shell"
commands = ["awk", "cat", "cd", "curl", "cut", "df", "du", "echo", "file", "find", "grep",
            "head", "ls", "make", "pwd", "rg", "sed", "sleep", "sort", "tail", "touch",
            "tr", "uniq", "wc", "which", "xargs"]

# [[commands.simple]]
# name = "process-mgmt"
# commands = ["pkill", "kill"]

# [[commands.simple]]
# name = "python"
# commands = ["pytest", "python", "ruff", "uvx"]

# [[commands.subcommand]]
# command = "uv"
# subcommands = ["pip", "run", "sync", "venv", "add", "remove", "lock"]


# Shell builtins for control flow
[[commands.regex]]
pattern = "^(true|false|exit(\s+\d+)?)$"
name = "shell builtin"

[[commands.regex]]
pattern = "^[A-Z_][A-Z0-9_]*=\S*$"
name = "var assignment"
